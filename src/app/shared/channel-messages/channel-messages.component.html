<!-- <div class="main-content"> -->
<div class="message-wrapper" #scrollContainer *ngIf="!isLoading">
  @for (group of groupedMessages; track group.dateString) {
  <app-timestamp-line [date]="handlingDateTime(group.date)" />

  @for (msg of group.messages; track msg.id) {
  <div class="message-wrapper-full" (mouseenter)="hoveredMessageId = msg.id" (mouseleave)="hoveredMessageId = null"
    [ngClass]="{ 'hovered': hoveredMessageId === msg.id }" [id]="'message-' + msg.id"
    [class.hovered]="hoveredMessageId === msg.id">

    <!-- Editing Mode -->
    @if (editingMessageId === msg.id) {
    <div class="edit-message-box">
      <textarea [(ngModel)]="editedMessageText" rows="3"></textarea>
      <div class="edit-message-toolbar">
        <button class="emoji-btn" (click)="toggleEmojiPicker(msg.id!)">
          <img src="/assets/images/sidenav-img/add_reaction.svg" alt="">
        </button>
      </div>

      @if (showEmojiPickerFor === msg.id) {
      <emoji-mart set="apple" (emojiSelect)="appendEmojiToEdit($event.emoji.native)"></emoji-mart>
      }

      <div class="edit-buttons">
        <button class="cancel-btn" (click)="cancelEditing()">Abbrechen</button>
        <button class="save-btn" (click)="saveEditedMessage(msg.id)">Speichern</button>
      </div>
    </div>
    } @else {

    <!-- Hover toolbar -->
    @if (hoveredMessageId === msg.id) {
    <div class="message-toolbar"
      [ngClass]="{'me': msg.senderId !== currentUserId, 'other': msg.senderId !== currentUserId}">
      <div class="message-options">
        <span class="emoji-button" (click)="reactToChannelMessage(msg.id!, '‚úÖ')">‚úÖ</span>
        <span class="emoji-button" (click)="reactToChannelMessage(msg.id!, 'üëç')">üëç</span>

        <img src="assets/icons/add_reaction.svg" alt="Reaktion" (click)="toggleEmojiPicker(msg.id!)" />

        <img src="assets/icons/Answer.svg" alt="Thread √∂ffnen" (click)="openThread(msg.id!)" />

        <img *ngIf="msg.senderId === currentUserId" src="assets/icons/option.svg" alt="Bearbeiten"
          title="Nachricht bearbeiten" (click)="startEditing(msg)" />
      </div>
    </div>
    }

    <!-- Default View -->
    <div class="message-content">
      <app-chat-box [src]="getAvatarPath(msg.senderId)" [userName]="getUserName(msg.senderId)"
        [time]="(msg.timestamp.toDate() | date:'shortTime') || ''" [message]="msg.text"
        [userMe]="msg.senderId !== currentUserId" [userId]="msg.senderId" (profileClick)="openProfileCard($event)"
        [isParentHovered]="hoveredMessageId === msg.id" />
    </div>

    <!-- Reactions, replies, and last reply time -->
    <div class="message-reactions-container" [ngClass]="{'me': msg.senderId === currentUserId}">
      <div class="reply-info">
        <!-- reply count (only if > 0) -->
        @if ((msg.replyCount ?? 0) > 0) {
          <a class="reply-count" (click)="openThread(msg.id!)">
            {{ msg.replyCount || 0 }} Antwort{{ (msg.replyCount || 0) > 1 ? 'en' : '' }}
          </a>
        }

        <!-- reactions -->
        @if (msg.reactions && objectKeys(msg.reactions).length > 0) {
          <div class="reactions-row">
            <!-- visible chips -->
            @for (r of getVisibleReactions(msg); track r.emoji) {
              <button class="reaction-chip" type="button"
                      [attr.aria-label]="getReactionTooltip(r.emoji, r.users)">
                <span class="emoji">{{ r.emoji }}</span>
                <span class="count">{{ r.count }}</span>
                <div class="tooltip">{{ getReactionTooltip(r.emoji, r.users) }}</div>
              </button>
            }

            <!-- +X chip -->
            @if (getHiddenCount(msg) > 0) {
              <button class="reaction-chip more" type="button"
                      (click)="toggleReactionsPopover(msg.id!)"
                      [attr.aria-expanded]="openReactionsPopoverFor === msg.id"
                      [attr.aria-label]="'Weitere Reaktionen anzeigen: ' + getHiddenCount(msg)">
                +{{ getHiddenCount(msg) }}
              </button>
            }
          </div>

          <!-- popover with remaining -->
          @if (openReactionsPopoverFor === msg.id) {
            <div class="reactions-popover" (mouseleave)="openReactionsPopoverFor = null">
              <div class="popover-header">Weitere Reaktionen</div>
              <div class="popover-grid">
                @for (r of getHiddenReactions(msg); track r.emoji) {
                  <div class="reaction-chip">
                    <span class="emoji">{{ r.emoji }}</span>
                    <span class="count">{{ r.count }}</span>
                    <div class="tooltip">{{ getReactionTooltip(r.emoji, r.users) }}</div>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>

    <!-- Emoji Picker -->
    @if (showEmojiPickerFor === msg.id) {
    <emoji-mart set="apple" (emojiSelect)="reactToMessage(msg.id, $event.emoji.native)">
    </emoji-mart>
    }
    }
  </div>
  }
  }
</div>

<!-- </div> -->

<!-- <div class="profile-card-overlay" *ngIf="showProfileCard" (click)="closeProfileCard()">
  <app-profile-card *ngIf="selectedUserForProfileCard as user" [name]="selectedUserForProfileCard.name"
    [email]="selectedUserForProfileCard.email || 'Guests have no email!'"
    [src]="selectedUserForProfileCard.avatarPath || ''" [active]="selectedUserForProfileCard.online"
    [isInsertedInHeader]="false" (click)="$event.stopPropagation()" (closeCard)="closeProfileCard()">
    <div class="button-container">
      <button [routerLink]="user.direktMessageLink" class="goToDm-button">
        <img src="./../../assets/icons/mode_comment.svg" alt="">
        Nachricht
      </button>
    </div>
  </app-profile-card>
</div> -->

<div class="spinner-container" *ngIf="isLoading">
  <app-spinner [size]="30" [color]="'rgb(68, 77, 242)'"></app-spinner>
</div>