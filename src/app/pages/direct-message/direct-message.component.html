<!-- Show nothing unless a user is selected -->
<ng-template #loadingSpinner>
   <!-- Spinner shown while selectedUser is loading -->
   <div class="spinner-container">
      <app-spinner [size]="30" [color]="'rgb(68, 77, 242)'"></app-spinner>
   </div>
</ng-template>
<ng-container *ngIf="areMessagesLoaded; else loadingSpinner">
   <section>
      <div class="headline">
         <div class="main-avatar" (click)="openProfileCard(selectedUser.uid)">
            <img [src]="selectedUser.avatarPath" alt="">
            <h3>{{ selectedUser.name }}</h3>
            <span class="online-dot" [ngStyle]="{
               'background-color': selectedUser.online ? 'rgba(146, 200, 62, 1)' : 'grey'
               }"></span>
         </div>
      </div>
      <div class="message" #scrollContainer>
         <ng-container *ngFor="let item of messages; let i = index;">
            <ng-container
               *ngIf="i === 0 || handlingDateTime(item.timestamp) !== handlingDateTime(messages[i-1].timestamp)">
               <div class="line-wrapper">
                  <app-timestamp-line [date]="handlingDateTime(item.timestamp)"></app-timestamp-line>
               </div>
            </ng-container>

            <div class="message-wrapper-full" (mouseenter)="hoveredMessageId = item.id ?? null"
               (mouseleave)="hoveredMessageId = null" [ngClass]="{ 'hovered': hoveredMessageId === item.id }"
               [id]="'message-' + item.id" [class.hovered]="hoveredMessageId === item.id">

               <div class="message-content">
                  <ng-container *ngIf="editingMessageId === item.id; else normalMessage">
                     <div class="edit-message-box">
                        <textarea [(ngModel)]="editedMessageText" rows="3"></textarea>

                        <div class="edit-message-toolbar">
                           <button class="emoji-btn" (click)="toggleEmojiPicker(item.id)">
                              <img src="assets/images/sidenav-img/add_reaction.svg" alt="">
                           </button>
                        </div>

                        <div *ngIf="showEmojiPickerFor === item.id">
                           <emoji-mart set="apple" (emojiSelect)="appendEmojiToEdit($event.emoji.native)">
                           </emoji-mart>
                        </div>

                        <div class="edit-buttons">
                           <button class="cancel-btn" (click)="cancelEditing()">Abbrechen</button>
                           <button class="save-btn" (click)="saveEditedMessage(item.id)">Speichern</button>
                        </div>
                     </div>
                  </ng-container>

                  <ng-template #normalMessage>
                     <div class="message-toolbar" *ngIf="hoveredMessageId === item.id"
                        [ngClass]="{ 'me': item.messageFrom !== currentUser?.userId, 'other': item.messageFrom !== currentUser?.userId }">
                        <div class="message-options">
                           <span class="emoji-button" (click)="reactToDirectMessage(item.id, 'üëç')">üëç</span>
                           <span class="emoji-button" (click)="reactToDirectMessage(item.id, '‚úÖ')">‚úÖ</span>

                           <img src="assets/icons/add_reaction.svg" alt="Reaktion"
                              (click)="toggleEmojiPicker(item.id!)" />

                           <img src="assets/icons/Answer.svg" alt="Thread √∂ffnen"
                              (click)="openThread(item.id!)" />

                           <img *ngIf="item.messageFrom == currentUser?.userId" src="assets/icons/option.svg"
                              alt="Bearbeiten" title="Nachricht bearbeiten" (click)="startEditing(item)" />
                        </div>
                     </div>

                     <app-chat-box *ngIf="areMessagesLoaded && areMessagesRendered && !isMessagesArrayEmpty"
                        [src]="userAvatarsMap[item.messageFrom] || 'assets/images/register/default-profile-img.svg'"
                        [userName]="userNamesMap[item.messageFrom] || 'Loading...'"
                        [time]="convertTimestampToString(item.timestamp)" [message]="item.message"
                        [userMe]="checkIfMessageIsFromLoggedInUser(i)"
                        (profileClick)="openProfileCard(item.messageFrom)" [userId]="item.messageFrom"
                        [isParentHovered]="hoveredMessageId === item.id"></app-chat-box>

                     <div class="message-reactions-container" *ngIf="hasReactions(item) || hasReplies(item)" [ngClass]="{'me': item.messageFrom === currentUserId}" appAutoYScroll [enabledBreakpoint]="580" [speed]="24">
                        <div class="reply-info">
                           @if (hasReplies(item)) {
                              <a class="reply-count" *ngIf="item.id" (click)="openThread(item.id)">
                              {{ item.replyCount }} Antwort{{ item.replyCount! > 1 ? 'en' : '' }}
                              </a>
                              @if (item.lastReplyTimestamp) {
                              <span class="last-reply-time">
                                 Letzte Antwort {{ getFormattedLastReplyTime(item.lastReplyTimestamp) }}
                              </span>
                              }
                           }
                           @if (hasReactions(item)) {
                              <div class="reactions-row">
                              <!-- visible chips -->
                              @for (r of getVisibleReactions(item); track r.emoji) {
                                 <button
                                    class="reaction-chip"
                                    type="button"
                                    [attr.aria-label]="getReactionTooltip(r.emoji, r.users)">
                                    <span class="emoji">{{ r.emoji }}</span>
                                    <span class="count">{{ r.count }}</span>
                                    <div class="tooltip">
                                    {{ getReactionTooltip(r.emoji, r.users) }}
                                    </div>
                                 </button>
                              }
                              <!-- +X chip -->
                              @if (getHiddenCount(item) > 0) {
                                 <button
                                    class="reaction-chip more"
                                    type="button"
                                    (click)="toggleReactionsPopover(item.id!)"
                                    [attr.aria-expanded]="openReactionsPopoverFor === item.id"
                                    [attr.aria-label]="'Weitere Reaktionen anzeigen: ' + getHiddenCount(item)">
                                    +{{ getHiddenCount(item) }}
                                 </button>
                              }
                              </div>
                              <!-- popover with all remaining -->
                              @if (openReactionsPopoverFor === item.id) {
                              <div class="reactions-popover" (mouseleave)="openReactionsPopoverFor = null">
                                 <div class="popover-header">Weitere Reaktionen</div>
                                 <div class="popover-grid">
                                    @for (r of getHiddenReactions(item); track r.emoji) {
                                    <div class="reaction-chip">
                                       <span class="emoji">{{ r.emoji }}</span>
                                       <span class="count">{{ r.count }}</span>
                                       <div class="tooltip">
                                          {{ getReactionTooltip(r.emoji, r.users) }}
                                       </div>
                                    </div>
                                    }
                                 </div>
                              </div>
                              }
                           }
                        </div>
                     </div>

                     <div *ngIf="showEmojiPickerFor === item.id">
                        <emoji-mart set="apple" (emojiSelect)="reactToMessage(item.id, $any($event).emoji.native)">
                        </emoji-mart>
                     </div>
                  </ng-template>
               </div>
            </div>
         </ng-container>
      </div>

      <!-- üîÅ Show spinner while messages are being processed (e.g., user names/avatars loaded) -->
      <div class="message-spinner-wrapper" *ngIf="areMessagesLoaded && !areMessagesRendered">
         <app-spinner [size]="30" [color]="'rgb(68, 77, 242)'"></app-spinner>
      </div>

      <!-- ‚úÖ Render only when chat is loaded, messages are empty, and rendering is complete -->
      <ng-container *ngIf="areMessagesLoaded && areMessagesRendered && isMessagesArrayEmpty">
         <div class="you-talk-to">
            <div class="secondary-avatar">
               <img [src]="selectedUser.avatarPath" alt="" (click)="openProfileCard(selectedUser.uid)" />
               <h3 (click)="openProfileCard(selectedUser.uid)">{{ selectedUser.name }}</h3>

               <h4 *ngIf="selectedUser?.uid === authService.currentUserId; else notSelfChat">
                  <span style="color: rgb(117 117 117); font-weight: 700; cursor: unset;">
                     Dieser Raum ist nur f√ºr dich da.
                  </span>
                  Mache dir Notizen, liste deine To-dos auf oder bewahre Links griffbereit auf. Du kannst hier auch
                  gerne mit dir selbst sprechen.
               </h4>

               <ng-template #notSelfChat>
                  <h4>
                     Diese Unterhaltung findet nur zwischen
                     <span (click)="openProfileCard(selectedUser.uid)">
                        &#64;<a>{{ selectedUser.name }}</a>
                     </span> und dir statt.
                  </h4>
               </ng-template>
            </div>
         </div>
      </ng-container>

      <div class="message-field-wrapper">
         <app-message-field (messageSend)="onMessageSend($event)"></app-message-field>
      </div>
   </section>
</ng-container>